<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Platform Ujian Online</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>
    <script>
      // Mengatur worker source untuk pdf.js agar bisa berjalan di lingkungan web
      pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.worker.min.js";
    </script>
    <style>
      /* Gaya dasar body */
      body {
        font-family: "Inter", sans-serif;
        background-color: #f8fafc; /* Tailwind gray-50 */
      }
      /* Gaya untuk card opsi jawaban yang dipilih */
      .selected-answer {
        border-color: #2563eb; /* Tailwind blue-600 */
        box-shadow: 0 0 0 2px #bfdbfe; /* Tailwind blue-200 */
      }
      /* Gaya untuk card jawaban benar di halaman hasil */
      .correct-answer-style {
        border: 2px dashed #16a34a; /* Tailwind green-600 */
        background-color: #dcfce7; /* Tailwind green-200 */
        color: #15803d; /* Tailwind green-700 */
      }
      /* Gaya untuk card jawaban salah di halaman hasil */
      .incorrect-answer-style {
        border: 2px dashed #dc2626; /* Tailwind red-600 */
        background-color: #fee2e2; /* Tailwind red-200 */
        color: #b91c1c; /* Tailwind red-700 */
      }
      /* Menyembunyikan radio button asli */
      input[type="radio"] {
        display: none;
      }
      /* Gaya dasar dan transisi untuk card opsi jawaban */
      .option-card {
        transition: all 0.2s ease-in-out;
        cursor: pointer;
      }
      /* Gaya hover untuk card opsi (jika tidak dipilih) */
      .option-card:not(.selected-answer):not(.bg-blue-100):hover {
        background-color: #e0e7ff; /* Tailwind indigo-100 */
      }
      /* Gaya label di dalam card opsi (hanya style dasar) */
      .option-card label {
        cursor: pointer;
        user-select: none; /* Mencegah teks terseleksi */
        display: block;
        /* Padding & Font size akan diatur via Tailwind class di JS */
      }
      /* Gaya untuk kotak pembahasan */
      .explanation-box {
        margin-top: 1rem;
        padding: 0.75rem;
        background-color: #f3f4f6; /* bg-gray-100 */
        border-left: 4px solid #6b7280; /* border-l-4 border-gray-500 */
        font-size: 0.875rem; /* text-sm */
        color: #4b5563; /* text-gray-700 */
        border-radius: 0.25rem; /* rounded */
      }
      /* Gaya animasi spinner loading */
      .spinner {
        border: 4px solid rgba(0, 0, 0, 0.1);
        width: 24px;
        height: 24px;
        border-radius: 50%;
        border-left-color: #09f; /* Warna animasi */
        animation: spin 1s ease infinite;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      /* Transisi untuk progress bar */
      #progress-bar-inner {
        transition: width 0.3s ease-in-out;
      }
      /* Gaya overlay untuk modal */
      .modal-overlay {
        background-color: rgba(0, 0, 0, 0.5);
      }
      /* Gaya area tombol upload */
      #upload-area {
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem; /* Mengurangi gap sedikit */
        align-items: center;
      }
      /* Gaya canvas confetti */
      #confetti-canvas {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none; /* Agar tidak mengganggu interaksi */
        z-index: 9999; /* Tampil di paling atas */
      }
      /* Gaya daftar file JSON yang tersedia di modal (hanya style dasar) */
      #available-json-list button {
        display: block;
        width: 100%;
        text-align: left;
        margin-bottom: 0.5rem;
        border: 1px solid #e5e7eb; /* gray-200 */
        border-radius: 0.375rem; /* rounded-md */
        background-color: #f9fafb; /* gray-50 */
        transition: background-color 0.2s;
        /* Padding & Font size akan diatur via Tailwind class di JS */
      }
      #available-json-list button:hover {
        background-color: #f3f4f6; /* gray-100 */
      }
      /* Gaya untuk tag materi */
      .material-tag {
        display: inline-block;
        background-color: #e0e7ff; /* indigo-100 */
        color: #3730a3; /* indigo-800 */
        padding: 0.25rem 0.6rem; /* py-1 px-2.5 */
        border-radius: 0.375rem; /* rounded-md */
        font-size: 0.75rem; /* text-xs */
        font-weight: 500; /* font-medium */
        margin-bottom: 0.75rem; /* mb-3 */
      }
      /* Gaya untuk display timer */
      #timer-display {
        font-weight: 600; /* font-semibold */
        color: #1f2937; /* gray-800 */
        background-color: #f3f4f6; /* gray-100 */
        padding: 0.25rem 0.75rem; /* py-1 px-3 */
        border-radius: 9999px; /* rounded-full */
        font-size: 0.875rem; /* text-sm */
        display: inline-flex;
        align-items: center;
        gap: 0.3rem; /* space-x-1.5 */
      }
      #timer-display.time-low {
        color: #dc2626; /* red-600 */
        background-color: #fee2e2; /* red-100 */
      }
      /* Gaya tambahan untuk teks soal */
      #question-text {
        white-space: normal; /* Kembali ke normal agar list wrap benar */
        line-height: 1.6; /* Atur jarak antar baris */
      }
      /* Styling untuk list di dalam teks soal */
      #question-text ul {
        list-style: none; /* Hapus bullet default */
        padding-left: 0; /* Hapus padding default */
        margin-top: 0.5rem; /* Jarak dari teks sebelumnya */
        margin-bottom: 0.5rem; /* Jarak ke teks sesudahnya */
      }
      #question-text li {
        padding-left: 1.5em; /* Indentasi untuk teks setelah bullet */
        position: relative; /* Untuk posisi bullet custom */
        margin-bottom: 0.25rem; /* Jarak antar item list */
      }
      #question-text li::before {
        content: "•"; /* Gunakan bullet custom */
        position: absolute;
        left: 0.5em; /* Posisi bullet */
        top: 0;
        font-weight: bold;
        color: #4b5563; /* Warna bullet (gray-600) */
      }
      /* Styling untuk paragraf simpulan */
      #question-text .conclusion-paragraph {
        margin-top: 0.75rem; /* Kurangi jarak atas simpulan */
      }
    </style>
  </head>
  <body class="flex items-center justify-center min-h-screen p-4 bg-gradient-to-br from-blue-50 to-indigo-100">
    <div id="app-container" class="w-full max-w-4xl bg-white rounded-lg shadow-xl overflow-hidden relative">
      <div id="landing-page">
        <div class="flex flex-col-reverse md:flex-row">
          <div class="w-full md:w-1/2 p-6 md:p-10 lg:p-12 flex flex-col justify-center">
            <h1 class="text-2xl md:text-3xl lg:text-4xl font-bold text-gray-800 mb-3 md:mb-4 leading-tight">Ujian Online <span class="text-blue-600">Lebih Mudah</span></h1>
            <p class="text-base md:text-lg text-gray-600 mb-6 md:mb-8">Unggah file PDF atau JSON berisi soal pilihan ganda Anda, atau pilih dari soal yang tersedia.</p>

            <div id="upload-area">
              <label for="pdf-upload" class="cursor-pointer bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 text-sm md:py-3 md:px-6 md:text-base rounded-lg transition duration-300 ease-in-out inline-flex items-center shadow-md hover:shadow-lg">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 md:h-5 md:w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                </svg>
                Pilih File PDF
              </label>
              <input id="pdf-upload" type="file" class="hidden" accept=".pdf" onchange="handleFileUpload(event)" />

              <button id="open-json-modal-button" onclick="openJsonSourceModal()" class="cursor-pointer bg-teal-600 hover:bg-teal-700 text-white font-semibold py-2 px-4 text-sm md:py-3 md:px-6 md:text-base rounded-lg transition duration-300 ease-in-out inline-flex items-center shadow-md hover:shadow-lg">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 md:h-5 md:w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4" />
                </svg>
                Pilih Sumber JSON
              </button>
              <input id="json-upload" type="file" class="hidden" accept=".json" onchange="handleJsonFileUpload(event)" />
            </div>
            <p id="upload-status" class="text-gray-600 text-sm mt-4 hidden"></p>
            <div id="upload-loading" class="hidden mt-4 flex items-center space-x-2 text-gray-600 text-sm">
              <div class="spinner"></div>
              <span id="loading-text">Mengunggah file...</span>
            </div>
          </div>
          <div class="w-full md:w-1/2 bg-gradient-to-br from-blue-400 to-indigo-500 p-8 flex items-center justify-center min-h-[200px] md:min-h-0">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-32 w-32 md:h-48 md:w-48 text-white opacity-80" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
              <path stroke-linecap="round" stroke-linejoin="round" d="M15 12H9m6 4H9m4-8l-4 4 4 4" />
            </svg>
          </div>
        </div>
      </div>

      <div id="onboarding-page" class="hidden p-6 md:p-10 lg:p-12">
        <div class="text-center max-w-md mx-auto">
          <div id="analysis-result">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 md:h-16 md:w-16 text-green-500 mx-auto mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <h2 class="text-xl md:text-2xl font-semibold text-gray-800 mb-3">File Siap!</h2>
            <p class="text-base md:text-lg text-gray-600 mb-2">Kami mendeteksi <strong id="question-count" class="text-blue-600">0</strong> soal dari file Anda.</p>
            <p id="total-time-info" class="text-base md:text-lg text-gray-600 mb-4 md:mb-6 hidden">Perkiraan total waktu pengerjaan: <strong id="total-time-value" class="text-blue-600">0 menit</strong></p>
            <p class="text-base md:text-lg text-gray-600 mb-6 md:mb-8">Apakah Anda siap untuk memulai ujian?</p>
            <button onclick="startExam()" class="w-full md:w-auto bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-6 text-sm md:py-3 md:px-8 md:text-base rounded-lg transition duration-300 ease-in-out shadow-md hover:shadow-lg">Mulai Ujian</button>
          </div>
        </div>
      </div>

      <div id="exam-page" class="hidden p-4 md:p-8 lg:p-10">
        <div class="mb-4 flex flex-wrap justify-between items-center gap-y-2">
          <h2 class="text-lg md:text-xl font-semibold text-gray-800">Soal <span id="current-question-number">1</span> dari <span id="total-questions">0</span></h2>
          <div class="flex items-center gap-x-3">
            <span id="material-tag-exam" class="material-tag hidden"></span>
            <div id="timer-display" class="hidden">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              <span id="time-left">--:--</span>
            </div>
          </div>
        </div>
        <div class="mb-6 w-full bg-gray-200 rounded-full h-2.5 dark:bg-gray-700">
          <div id="progress-bar-inner" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div>
        </div>
        <div id="question-container" class="mb-6 md:mb-8 p-4 md:p-6 bg-gray-50 rounded-lg border border-gray-200">
          <div id="question-text" class="text-base md:text-lg text-gray-700 mb-5 md:mb-6 font-medium"></div>
          <div id="options-container" class="space-y-3 md:space-y-4"></div>
        </div>
        <div class="flex justify-between items-center">
          <button id="prev-button" onclick="previousQuestion()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 text-sm md:px-6 md:text-base rounded-lg transition duration-300 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed">Sebelumnya</button>
          <button id="next-button" onclick="nextQuestion()" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 text-sm md:px-6 md:text-base rounded-lg transition duration-300 ease-in-out">Berikutnya</button>
          <button id="submit-button" onclick="submitExam()" class="hidden bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 text-sm md:px-6 md:text-base rounded-lg transition duration-300 ease-in-out">Submit Ujian</button>
        </div>
      </div>

      <div id="results-page" class="hidden p-4 md:p-8 lg:p-10">
        <h2 class="text-xl md:text-2xl lg:text-3xl font-bold text-center text-gray-800 mb-6 md:mb-8">Hasil Ujian Anda</h2>
        <div class="bg-gradient-to-r from-blue-500 to-indigo-600 text-white p-5 md:p-6 rounded-lg shadow-lg mb-8 md:mb-10 text-center">
          <p class="text-base md:text-lg mb-2">Skor Akhir Anda:</p>
          <p id="final-score" class="text-4xl md:text-5xl font-bold mb-2">0 / 100</p>
          <p id="score-summary" class="text-sm md:text-base text-blue-100">Anda menjawab 0 dari 0 soal dengan benar.</p>
          <p id="time-up-info" class="text-yellow-300 text-sm mt-2 hidden">Ujian dihentikan karena waktu habis.</p>
        </div>
        <h3 class="text-lg md:text-xl font-semibold text-gray-800 mb-5 md:mb-6">Rincian Jawaban & Pembahasan:</h3>
        <div id="results-details-container" class="space-y-6 md:space-y-8"></div>
        <div class="mt-8 md:mt-10 text-center">
          <button onclick="restartExam()" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-6 text-sm md:py-3 md:px-8 md:text-base rounded-lg transition duration-300 ease-in-out">Coba Lagi (Ulangi Ujian)</button>
        </div>
      </div>

      <div id="error-confirmation-dialog" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-overlay">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-sm w-full text-center">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 md:h-12 md:w-12 text-red-500 mx-auto mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
          </svg>
          <h3 class="text-base md:text-lg font-medium text-gray-900 mb-2">Gagal Memproses PDF</h3>
          <p id="error-message-detail" class="text-sm text-gray-600 mb-4 md:mb-6">Kami tidak dapat mengurai soal dari file PDF yang Anda unggah.</p>
          <p class="text-sm text-gray-600 mb-4">Apakah Anda ingin melanjutkan dengan data soal contoh?</p>
          <div class="flex justify-center space-x-3 md:space-x-4">
            <button id="use-dummy-data-button" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-3 md:px-4 rounded-lg transition duration-300 ease-in-out text-sm">Ya, Gunakan Contoh</button>
            <button id="try-another-file-button" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-3 md:px-4 rounded-lg transition duration-300 ease-in-out text-sm">Pilih File Lain</button>
          </div>
        </div>
      </div>

      <div id="json-source-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-overlay">
        <div class="bg-white rounded-lg shadow-xl p-5 md:p-6 max-w-md w-full">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-base md:text-lg font-medium text-gray-900">Pilih Sumber Soal JSON</h3>
            <button onclick="closeJsonSourceModal()" class="text-gray-400 hover:text-gray-600">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 md:h-6 md:w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
              </svg>
            </button>
          </div>

          <div id="json-modal-initial-options">
            <p class="text-sm text-gray-600 mb-5 md:mb-6">Anda dapat mengunggah file JSON dari perangkat Anda atau memilih dari daftar soal yang sudah tersedia.</p>
            <div class="space-y-3 md:space-y-4">
              <button id="trigger-json-upload-button" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 text-sm md:py-3 md:text-base px-4 rounded-lg transition duration-300 ease-in-out flex items-center justify-center space-x-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 md:h-5 md:w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                </svg>
                <span>Unggah File JSON</span>
              </button>
              <button id="show-available-json-button" class="w-full bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 text-sm md:py-3 md:text-base px-4 rounded-lg transition duration-300 ease-in-out flex items-center justify-center space-x-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 md:h-5 md:w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 10h16M4 14h16M4 18h16" />
                </svg>
                <span>Pilih Soal Tersedia</span>
              </button>
            </div>
          </div>

          <div id="json-modal-available-list" class="hidden">
            <p class="text-sm text-gray-600 mb-4">Pilih salah satu set soal berikut:</p>
            <div id="available-json-list" class="max-h-60 overflow-y-auto mb-4"></div>
            <button onclick="showInitialJsonOptions()" class="w-full text-sm text-blue-600 hover:underline">Kembali</button>
          </div>
        </div>
      </div>

      <canvas id="confetti-canvas"></canvas>
    </div>

    <script>
      // --- State Aplikasi (Variabel Global) ---
      let currentPage = "landing-page"; // Halaman aktif saat ini
      let questions = []; // Array FLAT untuk menyimpan data soal (termasuk materi)
      let userAnswers = []; // Array untuk menyimpan jawaban pengguna
      let currentQuestionIndex = 0; // Indeks soal yang ditampilkan
      let score = 0; // Skor akhir
      let timerInterval = null; // ID interval timer
      let timerSeconds = 0; // Sisa waktu dalam detik
      let totalExamTimeSeconds = 0; // Total waktu ujian dalam detik
      let timeIsUp = false; // Flag jika waktu habis

      // --- Konfigurasi Waktu per Materi (dalam detik) ---
      const timeLimitsPerMaterial = {
        "Word Classification": 8 * 60, // 8 menit
        "Verbal Logic": 18 * 60, // 18 menit
        Akhlak: 30 * 60, // 30 menit
        "Wawasan Kebangsaan": 5 * 60, // 5 menit
        "Pengetahuan Umum": 10 * 60, // Contoh: 10 menit
        "Matematika Dasar": 15 * 60, // Contoh: 15 menit
        "Dari PDF": 1 * 60, // Default: 1 menit per soal PDF
      };
      const defaultTimePerPdfQuestion = 1 * 60; // 1 menit per soal PDF jika materi tidak terdeteksi

      // --- Data Soal Contoh (Digunakan jika PDF gagal atau sebagai fallback) ---
      const mockQuestions = [
        {
          material: "Wawasan Kebangsaan",
          questions: [
            { question: "Hari Sumpah Pemuda diperingati setiap tanggal...", options: ["28 Oktober", "17 Agustus", "10 November", "1 Mei"], correctAnswer: 0, explanation: "Sumpah Pemuda diikrarkan pada tanggal 28 Oktober 1928." },
            { question: "Bhinneka Tunggal Ika memiliki arti...", options: ["Berbeda-beda tetapi tetap satu jua", "Bersatu kita teguh", "Majulah tanpa menyingkirkan", "Merdeka atau mati"], correctAnswer: 0, explanation: "Frasa ini berasal dari bahasa Jawa Kuno yang berarti 'Berbeda-beda tetapi tetap satu'." },
          ],
        },
        {
          material: "Akhlak",
          questions: [
            {
              question: "Prinsip dasar Akhlak BUMN adalah...",
              options: ["Amanah, Kompeten, Harmonis, Loyal, Adaptif, Kolaboratif", "Jujur, Adil, Bijaksana", "Cepat, Tepat, Akurat", "Inovatif, Kreatif, Produktif"],
              correctAnswer: 0,
              explanation: "AKHLAK merupakan akronim dari Amanah, Kompeten, Harmonis, Loyal, Adaptif, dan Kolaboratif.",
            },
          ],
        },
        // Contoh Soal Verbal Logic untuk testing format
        {
          material: "Verbal Logic",
          questions: [
            {
              // Contoh dengan cite dan simpulan di akhir
              question:
                "KONTEN IV: KOMPETISI WORK COFFEE EVENT\nTujuh orang barista kopi asal Indonesia akan mendatangi kompetisi Work Coffee Event yang diselenggarakan di Korea Selatan di tahun depan. Diketahui juga bahwa: • Terdapat tiga kategori pada kompetisi tersebut, yaitu brewer, baristo, dan spirit. [cite: 3] • Tiga orang dari Indonesia bertanding pada kategori brewer, sedangkan pada dua kategori lainnya diikuti oleh dua orang perwakilan. [cite: 5] Simpulan: Surya membayar biaya pendaftaran kompetisi sebesar Rp7.500.000,00. [cite: 7]",
              options: ["Simpulan Benar", "Simpulan Salah", "Tidak dapat disimpulkan"],
              correctAnswer: 2, // Contoh jawaban
              explanation: "Informasi mengenai Surya tidak ada dalam premis.",
            },
            {
              // Contoh tanpa kata "Simpulan:" tapi ada baris terakhir setelah list
              question: "KONTEN V: ATURAN PERPUSTAKAAN\nPengunjung harus menjaga ketenangan. • Dilarang membawa makanan atau minuman. • Buku yang dipinjam harus dikembalikan tepat waktu. Pengunjung yang melanggar akan dikenakan sanksi.",
              options: ["Benar", "Salah"],
              correctAnswer: 0,
              explanation: "Ini adalah contoh soal dimana baris terakhir dianggap simpulan.",
            },
            {
              // Contoh tanpa list dan tanpa kata "Simpulan:", hanya premis dan kesimpulan
              question: "Semua mamalia menyusui. Kucing adalah mamalia. Kucing menyusui.",
              options: ["Benar", "Salah"],
              correctAnswer: 0,
              explanation: "Ini adalah contoh silogisme deduktif yang valid.",
            },
          ],
        },
        { material: "Word Classification", questions: [{ question: "Manakah yang tidak termasuk kelompok: Meja, Kursi, Lemari, Buku", options: ["Meja", "Kursi", "Lemari", "Buku"], correctAnswer: 3, explanation: "Meja, Kursi, Lemari adalah perabotan, sedangkan Buku adalah alat tulis/baca." }] },
      ];

      // --- SIMULASI HASIL BUILD STEP (Daftar file JSON yang tersedia) --
      // CATATAN: Di lingkungan nyata, daftar ini mungkin dihasilkan oleh skrip build
      // atau diambil dari API. Untuk demonstrasi ini, kita hardcode.
      const availableSoalFiles = [
        "soal-verbal-logic1.json", // Akan diformat jika dipilih
        "soal-verbal-logic2.json", // Akan diformat jika dipilih
        "soal-tkd-word-classification1.json",
        "soal-tkd-word-classification2.json",
        "soal-akhlak.json",
        "soal-akhlak2.json",
        "soal-twk1.json",
        "soal_pengetahuan_umum.json",
        "soal_matematika_dasar.json",
        "soal_kosong.json",
      ];
      // --- AKHIR SIMULASI HASIL BUILD STEP ---

      // --- SIMULASI KONTEN FILE JSON ---
      // CATATAN: Di lingkungan nyata, konten ini akan di-fetch dari server/file
      // berdasarkan nama file yang dipilih dari `availableSoalFiles`.
      const availableJsonData = {
        "soal-verbal-logic1.json": [
          {
            material: "Verbal Logic",
            questions: [
              {
                question: "KONTEN I: DATA PENJUALAN BUKU\nSebuah toko buku mencatat penjualan buku selama seminggu. • Senin terjual 50 buku fiksi dan 30 buku non-fiksi. • Selasa terjual 40 buku fiksi. • Rabu terjual 60 buku non-fiksi. Simpulan: Total buku yang terjual pada hari Senin lebih banyak dari hari Rabu.",
                options: ["Benar", "Salah", "Tidak relevan"],
                correctAnswer: 0,
                explanation: "Senin terjual 50+30=80 buku. Rabu terjual 60 buku. 80 > 60.",
              },
              {
                question: "Jika hari ini cerah, maka saya akan pergi ke pantai. Hari ini tidak cerah. Simpulan: Saya tidak akan pergi ke pantai. [cite: 1]",
                options: ["Benar", "Salah", "Mungkin"],
                correctAnswer: 1,
                explanation: "Ini adalah fallacy 'denying the antecedent'. Tidak cerah bukan berarti pasti tidak pergi ke pantai.",
              },
            ],
          },
        ],
        "soal-verbal-logic2.json": [
          {
            material: "Verbal Logic",
            questions: [
              { question: "Beberapa dosen adalah peneliti. Semua peneliti membutuhkan dana riset. Simpulan: Beberapa dosen membutuhkan dana riset.", options: ["Benar", "Salah"], correctAnswer: 0, explanation: "Kesimpulan valid berdasarkan premis." },
              {
                question: "KONTEN II: JADWAL KERETA API\nKereta A berangkat pukul 08:00. Kereta B berangkat 30 menit setelah Kereta A. • Perjalanan Kereta A memakan waktu 2 jam. • Perjalanan Kereta B memakan waktu 1 jam 45 menit. Simpulan: Kereta B tiba lebih dulu daripada Kereta A.",
                options: ["Benar", "Salah"],
                correctAnswer: 1,
                explanation: "Kereta A tiba 08:00 + 2jam = 10:00. Kereta B berangkat 08:30, tiba 08:30 + 1j 45m = 10:15. Kereta A tiba lebih dulu.",
              },
            ],
          },
        ],
        "soal-tkd-word-classification1.json": [
          {
            material: "Word Classification",
            questions: [
              { question: "Manakah yang berbeda: Apel, Jeruk, Mangga, Pisang", options: ["Apel", "Jeruk", "Mangga", "Pisang"], correctAnswer: 3, explanation: "Apel, Jeruk, Mangga umumnya dianggap buah tropis/subtropis, Pisang lebih spesifik." }, // Contoh klasifikasi bisa bervariasi
              { question: "Manakah yang berbeda: Jakarta, Surabaya, Bandung, Malaysia", options: ["Jakarta", "Surabaya", "Bandung", "Malaysia"], correctAnswer: 3, explanation: "Jakarta, Surabaya, Bandung adalah kota di Indonesia, Malaysia adalah negara." },
            ],
          },
        ],
        "soal-tkd-word-classification2.json": [
          {
            material: "Word Classification",
            questions: [
              { question: "Manakah yang berbeda: Sepeda, Motor, Mobil, Pesawat", options: ["Sepeda", "Motor", "Mobil", "Pesawat"], correctAnswer: 3, explanation: "Sepeda, Motor, Mobil adalah kendaraan darat, Pesawat adalah kendaraan udara." },
              { question: "Manakah yang berbeda: Merah, Biru, Hijau, Terang", options: ["Merah", "Biru", "Hijau", "Terang"], correctAnswer: 3, explanation: "Merah, Biru, Hijau adalah warna spesifik, Terang adalah deskripsi intensitas cahaya/warna." },
            ],
          },
        ],
        "soal-akhlak.json": [
          {
            material: "Akhlak",
            questions: [
              { question: "Menjaga kerahasiaan data dan informasi perusahaan termasuk dalam nilai...", options: ["Amanah", "Kompeten", "Loyal", "Adaptif"], correctAnswer: 0, explanation: "Amanah berarti dapat dipercaya, termasuk dalam menjaga kerahasiaan." },
              { question: "Terus belajar dan mengembangkan kapabilitas adalah cerminan dari nilai...", options: ["Amanah", "Kompeten", "Harmonis", "Kolaboratif"], correctAnswer: 1, explanation: "Kompeten berarti terus meningkatkan kemampuan diri." },
            ],
          },
        ],
        "soal-akhlak2.json": [
          {
            material: "Akhlak",
            questions: [
              { question: "Membangun lingkungan kerja yang kondusif adalah bagian dari nilai...", options: ["Kompeten", "Harmonis", "Loyal", "Adaptif"], correctAnswer: 1, explanation: "Harmonis berarti saling peduli dan menghargai perbedaan untuk menciptakan lingkungan kerja yang kondusif." },
              { question: "Menjaga nama baik sesama karyawan, pimpinan, BUMN, dan Negara adalah implementasi nilai...", options: ["Amanah", "Kompeten", "Harmonis", "Loyal"], correctAnswer: 3, explanation: "Loyal berarti berdedikasi dan mengutamakan kepentingan Bangsa dan Negara, termasuk menjaga nama baik." },
            ],
          },
        ],
        "soal-twk1.json": [
          {
            material: "Wawasan Kebangsaan",
            questions: [
              { question: "Lambang negara Indonesia adalah...", options: ["Garuda Pancasila", "Bendera Merah Putih", "Bhinneka Tunggal Ika", "Indonesia Raya"], correctAnswer: 0, explanation: "Garuda Pancasila dengan semboyan Bhinneka Tunggal Ika adalah lambang negara." },
              { question: "Dasar negara Republik Indonesia adalah...", options: ["UUD 1945", "Pancasila", "Tap MPR", "GBHN"], correctAnswer: 1, explanation: "Pancasila adalah dasar filosofis dan ideologi negara Indonesia." },
            ],
          },
        ],
        "soal_pengetahuan_umum.json": [
          // Konten untuk file simulasi baru
          {
            material: "Pengetahuan Umum",
            questions: [
              { question: "Apa ibu kota negara Indonesia?", options: ["Jakarta", "Bandung", "Surabaya", "Yogyakarta"], correctAnswer: 0, explanation: "Jakarta adalah ibu kota resmi Republik Indonesia sesuai dengan Undang-Undang." },
              { question: "Siapakah presiden pertama Republik Indonesia?", options: ["Soeharto", "Joko Widodo", "Soekarno", "B.J. Habibie"], correctAnswer: 2, explanation: "Ir. Soekarno adalah proklamator kemerdekaan sekaligus presiden pertama Indonesia." },
              { question: "Gunung tertinggi di Indonesia adalah...", options: ["Gunung Semeru", "Gunung Rinjani", "Puncak Jaya", "Gunung Kerinci"], correctAnswer: 2, explanation: "Puncak Jaya (Cartensz Pyramid) adalah puncak tertinggi di Indonesia." },
            ],
          },
        ],
        "soal_matematika_dasar.json": [
          // Konten untuk file simulasi baru
          {
            material: "Matematika Dasar",
            questions: [
              { question: "Berapa hasil dari 5 + 7?", options: ["10", "11", "12", "13"], correctAnswer: 2, explanation: "5 + 7 = 12" },
              { question: "Berapa hasil dari 3 * 4?", options: ["9", "10", "11", "12"], correctAnswer: 3, explanation: "3 dikali 4 sama dengan 12" },
              { question: "Mana yang lebih besar, 1/2 atau 1/4?", options: ["1/2", "1/4", "Sama besar"], correctAnswer: 0, explanation: "Setengah (1/2) lebih besar dari seperempat (1/4)." },
            ],
          },
        ],
        "soal_kosong.json": [], // Konten untuk file simulasi kosong
      };
      // --- AKHIR SIMULASI KONTEN FILE JSON ---

      // --- Elemen DOM ---
      // Mendapatkan referensi ke elemen-elemen HTML yang akan dimanipulasi
      const appContainer = document.getElementById("app-container");
      const landingPage = document.getElementById("landing-page");
      const onboardingPage = document.getElementById("onboarding-page");
      const examPage = document.getElementById("exam-page");
      const resultsPage = document.getElementById("results-page");
      // Landing Page
      const uploadArea = document.getElementById("upload-area");
      const uploadLoading = document.getElementById("upload-loading");
      const loadingText = document.getElementById("loading-text");
      const uploadStatusEl = document.getElementById("upload-status");
      const pdfUploadInput = document.getElementById("pdf-upload");
      const jsonUploadInput = document.getElementById("json-upload");
      const openJsonModalButton = document.getElementById("open-json-modal-button");
      // Onboarding Page
      const analysisResult = document.getElementById("analysis-result");
      const questionCountEl = document.getElementById("question-count");
      const totalTimeInfoEl = document.getElementById("total-time-info"); // Elemen info total waktu
      const totalTimeValueEl = document.getElementById("total-time-value"); // Elemen nilai total waktu
      // Exam Page
      const currentQuestionNumberEl = document.getElementById("current-question-number");
      const totalQuestionsEl = document.getElementById("total-questions");
      const materialTagExamEl = document.getElementById("material-tag-exam");
      const timerDisplayEl = document.getElementById("timer-display"); // Elemen display timer
      const timeLeftEl = document.getElementById("time-left"); // Elemen sisa waktu
      const questionTextEl = document.getElementById("question-text"); // DIV untuk innerHTML
      const optionsContainerEl = document.getElementById("options-container");
      const prevButton = document.getElementById("prev-button");
      const nextButton = document.getElementById("next-button");
      const submitButton = document.getElementById("submit-button");
      const progressBarInner = document.getElementById("progress-bar-inner");
      // Resul Page
      const finalScoreEl = document.getElementById("final-score");
      const scoreSummaryEl = document.getElementById("score-summary");
      const timeUpInfoEl = document.getElementById("time-up-info"); // Elemen info waktu habis
      const resultsDetailsContainerEl = document.getElementById("results-details-container");
      // Error Dialog PDF
      const errorDialog = document.getElementById("error-confirmation-dialog");
      const errorMessageDetail = document.getElementById("error-message-detail");
      const useDummyDataButton = document.getElementById("use-dummy-data-button");
      const tryAnotherFileButton = document.getElementById("try-another-file-button");
      // Json Source Modal
      const jsonSourceModal = document.getElementById("json-source-modal");
      const jsonModalInitialOptions = document.getElementById("json-modal-initial-options");
      const jsonModalAvailableList = document.getElementById("json-modal-available-list");
      const availableJsonListContainer = document.getElementById("available-json-list");
      const triggerJsonUploadButton = document.getElementById("trigger-json-upload-button");
      const showAvailableJsonButton = document.getElementById("show-available-json-button");
      // Confetti Canvas
      const confettiCanvas = document.getElementById("confetti-canvas");
      const myConfetti = confetti.create(confettiCanvas, { resize: true, useWorker: true });

      // --- Fungsi Navigasi Halaman & UI Bantuan ---
      /**
       * Menampilkan halaman yang ditentukan dan menyembunyikan yang lain.
       * @param {string} pageId - ID elemen halaman yang akan ditampilkan.
       */
      function showPage(pageId) {
        const mainPages = [landingPage, onboardingPage, examPage, resultsPage];
        mainPages.forEach((page) => page.classList.add("hidden")); // Sembunyikan semua halaman utama
        const pageToShow = document.getElementById(pageId);
        if (pageToShow) {
          pageToShow.classList.remove("hidden"); // Tampilkan halaman yang diminta
          currentPage = pageId; // Update state halaman saat ini
        } else {
          console.error("Page not found:", pageId);
          landingPage.classList.remove("hidden"); // Tampilkan halaman landing page jika tidak ada yang ditemukan
          currentPage = "landing-page";
        }
        // Sembunyikan info waktu habis saat pindah halaman
        if (timeUpInfoEl) timeUpInfoEl.classList.add("hidden");
        timeIsUp = false; // Reset flag waktu habis
      }

      /**
       * Menampilkan indikator loading.
       * @param {string} [message="Memproses..."] - Pesan yang ditampilkan saat loading.
       */
      function showLoading(message = "Memproses...") {
        loadingText.textContent = message;
        uploadArea.classList.add("hidden"); // Sembunyikan area tombol unggah
        uploadStatusEl.classList.add("hidden"); // Sembunyikan status sebelumnya
        uploadLoading.classList.remove("hidden"); // Tampilkan spinner dan teks loading
      }

      /**
       * Menyembunyikan indikator loading.
       */
      function hideLoading() {
        uploadLoading.classList.add("hidden");
        uploadArea.classList.remove("hidden");
      }

      /**
       * Menampilkan pesan status (info atau error) di area upload.
       * @param {string} message - Pesan yang akan ditampilkan.
       * @param {boolean} [isError=false] - True jika pesan adalah error (warna merah).
       */
      function showStatus(message, isError = false) {
        uploadStatusEl.textContent = message;
        uploadStatusEl.classList.remove("hidden", "text-red-500", "text-gray-600");
        uploadStatusEl.classList.add(isError ? "text-red-500" : "text-gray-600");
        hideLoading(); // Selalu sembunyikan loading saat status muncul
      }

      /**
       * Menampilkan dialog konfirmasi error khusus untuk parsing PDF.
       * @param {string} message - Pesan detail error.
       */
      function showErrorDialog(message) {
        errorMessageDetail.textContent = message || "Kami tidak dapat mengurai soal dari file PDF yang Anda unggah.";
        errorDialog.classList.remove("hidden");
        errorDialog.classList.add("flex"); // Tampilkan modal overlay
      }

      /**
       * Menyembunyikan dialog konfirmasi error PDF dan mereset state upload.
       */
      function hideErrorDialog() {
        errorDialog.classList.add("hidden");
        errorDialog.classList.remove("flex");
        resetUploadState();
      }

      /**
       * Mereset nilai input file dan menyembunyikan status/loading.
       */
      function resetUploadState() {
        pdfUploadInput.value = null;
        jsonUploadInput.value = null;
        uploadStatusEl.classList.add("hidden");
        uploadArea.classList.remove("hidden");
        uploadLoading.classList.add("hidden");
      }

      // --- Fungsi Modal Pemilihan Sumber JSON ---
      /**
       * Membuka modal untuk memilih sumber file JSON.
       */
      function openJsonSourceModal() {
        jsonSourceModal.classList.remove("hidden");
        jsonSourceModal.classList.add("flex"); // Tampilkan modal overlay
        showInitialJsonOptions(); // Tampilkan opsi awal yang tersedia
      }

      /**
       * Menutup modal pemilihan sumber file JSON.
       */
      function closeJsonSourceModal() {
        jsonSourceModal.classList.add("hidden");
        jsonSourceModal.classList.remove("flex");
      }

      /**
       * Menampilkan bagian opsi awal (Unggah/Pilih Tersedia) di dalam modal JSON.
       */
      function showInitialJsonOptions() {
        jsonModalInitialOptions.classList.remove("hidden");
        jsonModalAvailableList.classList.add("hidden");
      }

      /**
       * Menampilkan bagian daftar file JSON yang tersedia di dalam modal JSON.
       */
      function showAvailableJsonList() {
        jsonModalInitialOptions.classList.add("hidden");
        jsonModalAvailableList.classList.remove("hidden");
        displayAvailableJsonFiles(); // Panggil fungsi untuk mengisi daftar
      }

      /**
       * Mengisi daftar tombol file JSON yang tersedia berdasarkan array `availableSoalFiles`.
       * KOMENTAR INTEGRASI: Fungsi ini menggunakan array `availableSoalFiles` hasil simulasi build step.
       */
      function displayAvailableJsonFiles() {
        availableJsonListContainer.innerHTML = ""; // Kosongkan daftar
        const fileNames = availableSoalFiles;
        if (!fileNames || fileNames.length === 0) {
          availableJsonListContainer.innerHTML = '<p class="text-sm text-gray-500 italic">Tidak ada soal tersedia (simulasi).</p>';
          return;
        }
        // Buat tombol untuk setiap file JSON yang tersedia
        fileNames.forEach((fileName) => {
          const button = document.createElement("button");
          // Menggabungkan gaya dari CSS ke JS untuk konsistensi
          button.className = "py-2 px-3 text-sm md:text-base w-full text-left mb-2 border border-gray-200 rounded-md bg-gray-50 hover:bg-gray-100 transition-colors duration-200";
          // Membuat nama tampilan yang lebih ramah
          const displayName = fileName
            .replace(".json", "") // Hapus ekstensi
            .replace(/[-_]/g, " ") // Ganti '-' atau '_' dengan spasi
            .replace(/\b\w/g, (l) => l.toUpperCase()); // Kapitalisasi setiap kata
          button.textContent = displayName;
          button.onclick = () => loadPredefinedJson(fileName);
          availableJsonListContainer.appendChild(button);
        });
      }

      /**
       * Memuat data soal dari file JSON yang telah ditentukan (simulasi).
       * KOMENTAR INTEGRASI: Fungsi ini masih menggunakan `availableJsonData` untuk KONTEN soal
       * dalam simulasi ini karena keterbatasan browser untuk membaca file lokal secara langsung
       * atau fetch dari path lokal tanpa server.
       * @param {string} fileName - Nama file yang dipilih dari daftar (hasil build step).
       */
      async function loadPredefinedJson(fileName) {
        console.log(`Memuat soal dari file: ${fileName}`);
        closeJsonSourceModal();
        showLoading(`Memuat soal ${fileName.replace(".json", "").replace(/_/g, " ")}...`);

        // --- KOMENTAR INTEGRASI: Bagian ini masih menggunakan data simulasi untuk konten ---
        // Di aplikasi nyata, Anda akan fetch konten berdasarkan `fileName`
        // Contoh fetch: const response = await fetch(`/soal_json/${fileName}`); data = await response.json();
        await new Promise((resolve) => setTimeout(resolve, 300));
        try {
          // const data = availableJsonData[fileName]; // Ambil KONTEN dari data simulasi
          let data;
          try {
            const response = await fetch(`src/soal-json/${fileName}`);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            data = await response.json();
            console.log(`Soal berhasil di-fetch dari src/soal-json/${fileName}`);
          } catch (fetchError) {
            console.warn(`Fetch gagal untuk ${fileName}, mencoba data simulasi. Error: ${fetchError.message}`);
            data = availableJsonData[fileName];
            if (data === undefined) throw new Error(`Konten simulasi untuk ${fileName} tidak ditemukan.`);
            console.log(`Menggunakan data simulasi untuk ${fileName}`);
          }
          // Validasi konten yang didapat
          if (validateJsonData(data, fileName)) {
            questions = flattenJsonData(data); // Gunakan data ini
            console.log("Soal berhasil dimuat dan diflatten:", questions);
            calculateAndShowTotalTime(); // Hitung dan tampilkan total waktu
            hideLoading();
            proceedToOnboarding(); // Tampilkan halaman onboarding
          } else {
            // Jika Validasi Gagal
            resetUploadState();
          }
        } catch (error) {
          // Jika nama file ada di `availableSoalFiles` tapi tidak ada kontennya di `availableJsonData`
          console.error(`Gagal memuat atau memvalidasi file JSON: ${fileName}`, error);
          showStatus(`Gagal memuat soal dari ${fileName}. ${error.message}`, true);
          resetUploadState();
        }
      }

      // --- Fungsi Logika Inti Ujian ---
      /**
       * Menangani unggahan file PDF, mengekstrak teks, dan mencoba mengurainya.
       * @param {Event} event - Event dari input file.
       */
      async function handleFileUpload(event) {
        const file = event.target.files[0];
        uploadStatusEl.classList.add("hidden");
        if (!file || file.type !== "application/pdf") {
          showStatus("Harap unggah file dengan format PDF.", true);
          resetUploadState();
          return;
        }
        showLoading("Membaca file PDF...");
        try {
          const fileReader = new FileReader();
          fileReader.onload = async (loadEvent) => {
            const pdfData = new Uint8Array(loadEvent.target.result);
            showLoading("Mengekstrak teks dari PDF...");
            try {
              // Memuat dokumen PDF
              const pdfDocument = await pdfjsLib.getDocument({ data: pdfData }).promise;
              let fullText = "";
              // Iterasi melalui setiap halaman
              for (let i = 1; i <= pdfDocument.numPages; i++) {
                const page = await pdfDocument.getPage(i);
                const textContent = await page.getTextContent();
                // Menggabungkan item teks, mencoba mempertahankan baris baru
                let lastY = -1;
                let pageText = "";
                textContent.items.forEach((item) => {
                  // Cek posisi Y untuk mendeteksi baris baru (perkiraan)
                  if (lastY !== -1 && item.transform[5] < lastY - 5) {
                    // Toleransi 5 unit
                    pageText += "\n";
                  } else if (lastY !== -1 && item.transform[5] === lastY && !pageText.endsWith(" ")) {
                    // Tambah spasi jika item berada di baris yang sama dan belum ada spasi
                    pageText += " ";
                  }
                  pageText += item.str;
                  lastY = item.transform[5]; // Simpan posisi Y terakhir
                });
                // Tambahkan teks halaman ke teks keseluruhan, bersihkan spasi ganda
                fullText += pageText.replace(/\s+/g, " ").trim() + "\n\n";
              }

              showLoading("Mengurai soal dari PDF...");
              const parsedQuestions = parseQuestionsFromText(fullText);

              if (parsedQuestions.length > 0) {
                questions = parsedQuestions; // Langsung gunakan hasil parse PDF
                console.log("Soal berhasil diparsing dari PDF:", questions);
                calculateAndShowTotalTime(); // Hitung waktu setelah parsing
                hideLoading();
                proceedToOnboarding();
              } else {
                // Jika parsing tidak menghasilkan soal
                throw new Error("Tidak ada soal yang dapat diurai dari teks PDF. Pastikan format penomoran (misal: 1.) dan opsi (misal: A.) jelas dan konsisten.");
              }
            } catch (parseError) {
              // Tangani error saat memproses atau mengurai PDF
              console.error("Error saat memproses atau mengurai PDF:", parseError);
              hideLoading();
              showErrorDialog(`Gagal memproses PDF: ${parseError.message}. Format mungkin tidak didukung atau tidak ada soal terdeteksi.`);
            }
          };
          fileReader.onerror = () => {
            // Tangani error saat membaca file
            console.error("Gagal membaca file PDF.");
            showStatus("Gagal membaca file PDF.", true);
            hideLoading();
            resetUploadState();
          };
          // Baca file sebagai ArrayBuffer
          fileReader.readAsArrayBuffer(file);
        } catch (uploadError) {
          // Tangani error pada persiapan upload
          console.error("Error saat persiapan unggah PDF:", uploadError);
          showStatus("Terjadi kesalahan saat memproses file PDF.", true);
          hideLoading();
          resetUploadState();
        }
      }

      /**
       * Menangani unggahan file JSON, mem-parsing, dan memvalidasinya.
       * Dipicu oleh input file tersembunyi.
       * @param {Event} event - Event dari input file.
       */
      async function handleJsonFileUpload(event) {
        closeJsonSourceModal(); // Tutup modal jika masih terbuka
        const file = event.target.files[0];
        uploadStatusEl.classList.add("hidden");
        if (!file) {
          resetUploadState();
          return; // Tidak ada file dipilih
        }
        if (file.type !== "application/json") {
          showStatus("Harap unggah file dengan format JSON.", true);
          resetUploadState();
          return;
        }
        showLoading("Membaca file JSON...");
        try {
          const fileReader = new FileReader();
          fileReader.onload = async (loadEvent) => {
            showLoading("Memvalidasi data JSON...");
            try {
              const jsonData = JSON.parse(loadEvent.target.result);
              if (validateJsonData(jsonData, file.name)) {
                // Panggil flattenJsonData yang sudah dimodifikasi
                questions = flattenJsonData(jsonData);
                console.log("Soal berhasil dimuat dan diflatten dari JSON:", questions);
                if (questions.length > 0) {
                  calculateAndShowTotalTime(); // Hitung waktu setelah flatten
                  hideLoading();
                  proceedToOnboarding();
                } else {
                  // Kasus file JSON valid tapi kosong
                  showStatus(`File "${file.name}" berhasil dimuat tetapi tidak berisi soal.`, true);
                  resetUploadState();
                }
              } else {
                // Jika validasi gagal, pesan error sudah ditampilkan oleh validateJsonData
                resetUploadState();
              }
            } catch (parseError) {
              // Tangani error jika JSON tidak valid
              console.error("Error parsing JSON:", parseError);
              showStatus(`Gagal memproses file ${file.name}: Format JSON tidak valid.`, true);
              resetUploadState();
            }
          };
          fileReader.onerror = () => {
            // Tangani error saat membaca file
            console.error("Gagal membaca file JSON.");
            showStatus("Gagal membaca file JSON.", true);
            hideLoading();
            resetUploadState();
          };
          // Baca file sebagai teks
          fileReader.readAsText(file);
        } catch (uploadError) {
          // Tangani error pada persiapan upload
          console.error("Error saat persiapan unggah JSON:", uploadError);
          showStatus("Terjadi kesalahan saat memproses file JSON.", true);
          hideLoading();
          resetUploadState();
        }
      }

      /**
       * Memvalidasi struktur array data soal JSON.
       * Struktur yang diharapkan: Array of Objects, setiap Object punya key 'material' (string)
       * dan 'questions' (Array of question Objects).
       * Setiap question Object punya 'question' (string), 'options' (Array of strings min 2),
       * 'correctAnswer' (number/index), 'explanation' (string).
       * @param {any} data - Data yang akan divalidasi.
       * @param {string} [sourceName="Data"] - Nama sumber data untuk pesan error.
       * @returns {boolean} - True jika data valid, false jika tidak.
       */
      function validateJsonData(data, sourceName = "Data") {
        // 1. Periksa apakah data utama adalah array
        if (!Array.isArray(data)) {
          showStatus(`Struktur tidak valid (${sourceName}): Data utama harus berupa array materi.`, true);
          return false;
        }

        // Jika array kosong, anggap valid tapi beri info (ditangani setelah flatten)
        if (data.length === 0) {
          console.log(`Data JSON (${sourceName}) valid tetapi kosong.`);
          return true; // Valid tapi kosong
        }

        // 2. Iterasi setiap item materi dalam array utama
        for (let i = 0; i < data.length; i++) {
          const materialItem = data[i];
          const materialNumber = i + 1;

          // 2a. Periksa apakah item materi adalah objek valid dengan properti yang diperlukan
          if (!materialItem || typeof materialItem !== "object" || !materialItem.hasOwnProperty("material") || typeof materialItem.material !== "string" || materialItem.material.trim() === "" || !materialItem.hasOwnProperty("questions") || !Array.isArray(materialItem.questions)) {
            showStatus(`Struktur tidak valid (${sourceName}): Item materi #${materialNumber} harus objek dengan properti 'material' (string non-kosong) dan 'questions' (array).`, true);
            return false;
          }

          // Jika array questions kosong, lewati ke materi berikutnya (valid tapi tanpa soal)
          if (materialItem.questions.length === 0) {
            console.log(`Materi "${materialItem.material}" (${sourceName}) tidak memiliki soal.`);
            continue;
          }

          // 3. Iterasi setiap soal dalam array 'questions' materi saat ini
          for (let j = 0; j < materialItem.questions.length; j++) {
            const q = materialItem.questions[j];
            const questionNumberInMaterial = j + 1;

            // 3a. Periksa apakah soal adalah objek valid dengan properti yang diperlukan
            if (
              !q ||
              typeof q !== "object" ||
              !q.hasOwnProperty("question") ||
              typeof q.question !== "string" ||
              q.question.trim() === "" ||
              !q.hasOwnProperty("options") ||
              !Array.isArray(q.options) ||
              q.options.length < 2 || // Harus ada minimal 2 opsi jawaban
              !q.hasOwnProperty("correctAnswer") ||
              typeof q.correctAnswer !== "number" ||
              !Number.isInteger(q.correctAnswer) || // Pastikan integer
              !q.hasOwnProperty("explanation") || // Pembahasan wajib ada
              typeof q.explanation !== "string" // Tipe pembahasan harus string
              // Kita tidak mewajibkan explanation tidak kosong, bisa saja ""
            ) {
              showStatus(`Struktur tidak valid (${sourceName}): Soal #${questionNumberInMaterial} dalam materi "${materialItem.material}" memiliki format atau properti yang salah (cek 'question', 'options' [min 2], 'correctAnswer' [integer], 'explanation').`, true);
              return false;
            }

            // 3b. Periksa apakah semua opsi adalah string non-kosong
            if (!q.options.every((opt) => typeof opt === "string" && opt.trim() !== "")) {
              showStatus(`Struktur tidak valid (${sourceName}): Semua 'options' pada soal #${questionNumberInMaterial} dalam materi "${materialItem.material}" harus berupa teks (string) non-kosong.`, true);
              return false;
            }

            // 3c. Periksa apakah correctAnswer adalah indeks yang valid dalam array options
            if (q.correctAnswer < 0 || q.correctAnswer >= q.options.length) {
              showStatus(`Struktur tidak valid (${sourceName}): Nilai 'correctAnswer' (${q.correctAnswer}) pada soal #${questionNumberInMaterial} dalam materi "${materialItem.material}" berada di luar rentang indeks opsi yang valid (0 sampai ${q.options.length - 1}).`, true);
              return false;
            }
          }
        }

        // Jika semua pemeriksaan lolos
        console.log(`Validasi JSON untuk "${sourceName}" berhasil.`);
        return true;
      }

      /**
       * Mengubah struktur data JSON menjadi array soal tunggal (flat)
       * dan menerapkan format khusus untuk soal "Verbal Logic".
       * @param {Array<object>} jsonData - Data JSON yang sudah divalidasi.
       * @returns {Array<object>} - Array soal yang sudah di-flatten dan diformat.
       */
      function flattenJsonData(jsonData) {
        const flatQuestions = [];
        jsonData.forEach((materialItem) => {
          if (materialItem && materialItem.questions && Array.isArray(materialItem.questions)) {
            materialItem.questions.forEach((question) => {
              let formattedQuestion = { ...question, material: materialItem.material };

              // Terapkan pemformatan hanya untuk materi "Verbal Logic"
              if (formattedQuestion.material === "Verbal Logic") {
                let originalText = formattedQuestion.question;

                // 1. Hapus [cite: <angka>] dan spasi sekitarnya
                originalText = originalText.replace(/\s*\[cite:\s*\d+\]\s*/g, "");

                // 2. Ekstrak teks Simpulan dan hapus dari teks utama
                let simpulanText = "";
                const simpulanRegex = /\s*(?:Simpulan:|simpulan:)\s*([\s\S]+)/i;
                const simpulanMatch = originalText.match(simpulanRegex);
                if (simpulanMatch) {
                  simpulanText = simpulanMatch[1].trim();
                  originalText = originalText.replace(simpulanRegex, "").trim();
                } else {
                  // Fallback: Asumsikan baris terakhir yang tidak kosong setelah bullet terakhir adalah simpulan
                  const lines = originalText
                    .split("\n")
                    .map((l) => l.trim())
                    .filter((l) => l);
                  const lastBulletLineIndex = lines.findLastIndex((l) => l.startsWith("•"));

                  if (lastBulletLineIndex !== -1 && lastBulletLineIndex < lines.length - 1) {
                    const potentialSimpulanLines = lines.slice(lastBulletLineIndex + 1);
                    simpulanText = potentialSimpulanLines.join(" ").trim();
                    originalText = lines
                      .slice(0, lastBulletLineIndex + 1)
                      .join("\n")
                      .trim();
                  }
                }

                // 3. Proses teks utama (sebelum simpulan)
                let htmlOutput = "";
                const firstBulletIndex = originalText.indexOf("•");

                if (firstBulletIndex !== -1) {
                  // Ada daftar berpoin
                  let textBeforeList = originalText.substring(0, firstBulletIndex).trim();
                  let listPart = originalText.substring(firstBulletIndex).trim();

                  // Proses teks sebelum daftar
                  textBeforeList = textBeforeList.replace(/^(KONTEN\s+[IVXLCDM]+:\s*[A-Z\s]+)/gm, (match) => `<strong>${match.trim()}</strong>`);
                  htmlOutput += textBeforeList.replace(/\n/g, "<br>"); // Ganti newline dengan <br>

                  // Proses daftar berpoin
                  const listItems = listPart
                    .split("•")
                    .map((item) => item.trim())
                    .filter((item) => item);
                  if (listItems.length > 0) {
                    if (htmlOutput.length > 0) {
                      htmlOutput += "<br>"; // Jarak sebelum list
                    }
                    htmlOutput += "<ul>" + listItems.map((item) => `<li>${item}</li>`).join("") + "</ul>";
                  }
                } else {
                  // Tidak ada daftar berpoin, proses sebagai paragraf biasa
                  originalText = originalText.replace(/^(KONTEN\s+[IVXLCDM]+:\s*[A-Z\s]+)/gm, (match) => `<strong>${match.trim()}</strong>`);
                  htmlOutput += originalText.replace(/\n/g, "<br>");
                }

                // 4. Tambahkan Simpulan jika ada
                if (simpulanText) {
                  if (htmlOutput.length > 0) {
                    htmlOutput += "<br>"; // Jarak sebelum simpulan (satu baris)
                  }
                  htmlOutput += `<div class="conclusion-paragraph">${simpulanText}</div>`;
                }

                // Tetapkan HTML yang dihasilkan ke properti question
                formattedQuestion.question = htmlOutput.trim();
              }
              // --- END: Formatting Logic ---

              flatQuestions.push(formattedQuestion);
            });
          }
        });
        return flatQuestions;
      }

      /**
       * Mencoba mengurai teks mentah dari PDF menjadi struktur soal.
       * Menggunakan Regex untuk mencari pola nomor soal diikuti teks,
       * dan pola opsi (A., B., C., dst.) diikuti teks.
       * @param {string} text - Teks mentah yang diekstrak dari PDF.
       * @returns {Array<object>} - Array objek soal yang berhasil diurai.
       */
      function parseQuestionsFromText(text) {
        console.log("Mencoba mengurai teks PDF...");
        const parsed = [];
        // Regex untuk blok soal: angka diikuti titik, spasi, lalu teks (non-greedy),
        // diakhiri oleh awal opsi (A.), awal soal berikutnya (1.), atau akhir teks.
        // Modifikasi: Memperbolehkan spasi atau newline setelah nomor soal.
        // Modifikasi: Mencari opsi dengan lebih fleksibel (A., B., C., D., E.)
        const questionBlockRegex = /(\d+)\.\s*([\s\S]+?)(?=\n\s*[A-E]\.\s+|\n\s*\d+\.\s+|$)/g;

        // Regex untuk opsi: Huruf A-E diikuti titik, spasi, lalu teks (non-greedy),
        // diakhiri oleh awal opsi berikutnya, awal soal berikutnya, atau akhir teks.
        const optionRegex = /([A-E])\.\s+([\s\S]+?)(?=\n\s*[A-E]\.\s+|\n\s*\d+\.\s+|$)/g;

        let match;
        while ((match = questionBlockRegex.exec(text)) !== null) {
          const questionNumber = match[1];
          let fullBlock = match[2].trim(); // Teks setelah nomor soal sampai sebelum opsi/soal berikutnya
          let questionText = fullBlock; // Default teks soal adalah seluruh blok
          const options = [];
          const optionMap = {}; // Untuk menyimpan opsi yang ditemukan (A: teks, B: teks, ...)

          let optionMatch;
          optionRegex.lastIndex = 0; // Reset index regex opsi untuk setiap blok soal

          // Cari semua opsi dalam blok saat ini
          while ((optionMatch = optionRegex.exec(fullBlock)) !== null) {
            const optionLetter = optionMatch[1]; // Huruf opsi (A, B, C, ...)
            const optionText = optionMatch[2].trim(); // Teks opsi

            // Simpan opsi jika hurufnya valid (A-E)
            if (["A", "B", "C", "D", "E"].includes(optionLetter)) {
              optionMap[optionLetter] = optionText;
            }

            // Jika ini adalah opsi pertama yang ditemukan, potong teks soal
            if (Object.keys(optionMap).length === 1 && optionMatch.index > 0) {
              questionText = fullBlock.substring(0, optionMatch.index).trim();
            }
          }

          // Urutkan opsi berdasarkan huruf (A, B, C, D, E) dan masukkan ke array
          ["A", "B", "C", "D", "E"].forEach((letter) => {
            if (optionMap[letter]) {
              options.push(optionMap[letter]);
            }
          });

          // Jika teks soal ditemukan dan ada minimal 2 opsi
          if (questionText && options.length >= 2) {
            parsed.push({
              material: "Dari PDF", // Materi default untuk soal PDF
              question: questionText, // Teks soal dari PDF tidak diformat khusus di sini
              options: options,
              correctAnswer: 0, // Default jawaban benar (index 0), karena tidak bisa dideteksi dari PDF
              explanation: "Pembahasan tidak tersedia dari PDF.", // Default pembahasan
            });
          } else {
            console.warn(`Gagal mengurai blok soal PDF di sekitar nomor ${questionNumber}. Teks Soal: "${questionText}", Opsi Ditemukan: ${options.length}`);
          }
        }
        console.log(`Hasil parsing PDF: ${parsed.length} soal ditemukan.`);
        return parsed;
      }

      /**
       * Menghitung total waktu ujian berdasarkan materi soal dalam array `questions`.
       * Menggunakan konfigurasi `timeLimitsPerMaterial` dan `defaultTimePerPdfQuestion`.
       * Memperbarui `totalExamTimeSeconds` dan menampilkan info di halaman onboarding.
       */
      function calculateAndShowTotalTime() {
        totalExamTimeSeconds = 0;
        // Gunakan Set untuk mendapatkan daftar materi unik dari soal yang sudah di-flatten
        const uniqueMaterials = new Set(questions.map((q) => q.material));

        uniqueMaterials.forEach((material) => {
          if (material === "Dari PDF") {
            // Hitung jumlah soal yang berasal dari PDF
            const pdfQuestionCount = questions.filter((q) => q.material === "Dari PDF").length;
            totalExamTimeSeconds += pdfQuestionCount * defaultTimePerPdfQuestion;
            console.log(`Waktu untuk ${pdfQuestionCount} soal PDF: ${(pdfQuestionCount * defaultTimePerPdfQuestion) / 60} menit`);
          } else if (timeLimitsPerMaterial[material]) {
            // Jika materi ada di konfigurasi waktu
            totalExamTimeSeconds += timeLimitsPerMaterial[material];
            console.log(`Waktu untuk materi "${material}": ${timeLimitsPerMaterial[material] / 60} menit`);
          } else {
            // Jika materi tidak ada di konfigurasi (misal dari JSON tanpa konfigurasi waktu)
            // Beri waktu default per soal (gunakan default PDF sebagai fallback)
            const unknownMaterialCount = questions.filter((q) => q.material === material).length;
            totalExamTimeSeconds += unknownMaterialCount * defaultTimePerPdfQuestion;
            console.warn(`Materi "${material}" tidak ditemukan dalam konfigurasi waktu. Menggunakan waktu default ${defaultTimePerPdfQuestion / 60} menit per soal (${unknownMaterialCount} soal).`);
          }
        });

        console.log(`Total waktu ujian dihitung: ${totalExamTimeSeconds} detik (${totalExamTimeSeconds / 60} menit)`);

        // Tampilkan info total waktu di halaman onboarding jika waktu > 0
        if (totalExamTimeSeconds > 0 && totalTimeInfoEl && totalTimeValueEl) {
          totalTimeValueEl.textContent = `${Math.ceil(totalExamTimeSeconds / 60)} menit`;
          totalTimeInfoEl.classList.remove("hidden");
        } else if (totalTimeInfoEl) {
          // Sembunyikan jika waktu 0 atau elemen tidak ada
          totalTimeInfoEl.classList.add("hidden");
        }
      }

      /**
       * Mempersiapkan dan menampilkan halaman onboarding setelah soal berhasil dimuat dan diproses.
       * Mereset state ujian sebelumnya.
       */
      function proceedToOnboarding() {
        // Pastikan loading disembunyikan
        if (!uploadLoading.classList.contains("hidden")) {
          hideLoading();
        }

        // Reset state ujian
        userAnswers = new Array(questions.length).fill(null); // Reset jawaban pengguna
        currentQuestionIndex = 0; // Kembali ke soal pertama
        score = 0; // Reset skor
        stopTimer(); // Hentikan timer jika ada dari sesi sebelumnya
        timeIsUp = false; // Reset flag waktu habis

        // Cek apakah ada soal yang valid
        if (questions.length > 0) {
          showPage("onboarding-page"); // Tampilkan halaman onboarding
          questionCountEl.textContent = questions.length; // Update jumlah soal
          if (totalQuestionsEl) totalQuestionsEl.textContent = questions.length; // Update total soal di exam page juga
          // Info waktu sudah dihitung dan ditampilkan oleh calculateAndShowTotalTime() sebelumnya
        } else {
          // Jika setelah proses (PDF/JSON) tidak ada soal ditemukan
          showStatus("File berhasil diproses, tetapi tidak ada soal yang ditemukan.", true);
          resetUploadState(); // Kembali ke state upload awal
          showPage("landing-page"); // Kembali ke halaman landing
        }
      }

      /**
       * Memulai ujian: menampilkan soal pertama dan memulai timer.
       */
      function startExam() {
        // Pastikan ada soal untuk dimulai
        if (questions.length === 0) {
          console.error("Tidak ada soal untuk memulai ujian.");
          // Mungkin kembali ke landing page atau tampilkan pesan error
          restartExam();
          showStatus("Gagal memulai ujian karena tidak ada soal.", true);
          return;
        }
        currentQuestionIndex = 0; // Mulai dari soal pertama
        if (totalQuestionsEl) totalQuestionsEl.textContent = questions.length; // Set total soal
        displayQuestion(currentQuestionIndex); // Tampilkan soal pertama
        showPage("exam-page"); // Pindah ke halaman ujian
        startTimer(); // Mulai timer
      }

      /**
       * Menampilkan soal dan opsi jawaban berdasarkan indeks.
       * Memperbarui UI elemen seperti nomor soal, teks soal (menggunakan innerHTML),
       * opsi, progress bar, dan tag materi.
       * @param {number} index - Indeks soal yang akan ditampilkan dalam array `questions`.
       */
      function displayQuestion(index) {
        // Validasi indeks
        if (index < 0 || index >= questions.length || !questions[index]) {
          console.error(`Indeks soal tidak valid atau data soal tidak ditemukan: ${index}`);
          submitExam(); // Atau handle error lain
          return;
        }

        const q = questions[index]; // Dapatkan objek soal saat ini

        // Update nomor soal
        currentQuestionNumberEl.textContent = index + 1;

        // Update teks soal MENGGUNAKAN innerHTML untuk merender format HTML (<br>, <strong>, <ul>, <li>)
        questionTextEl.innerHTML = q.question; // Ganti dari textContent ke innerHTML

        // Kosongkan kontainer opsi sebelum menambahkan yang baru
        optionsContainerEl.innerHTML = "";

        // Tampilkan tag materi jika ada
        if (q.material && materialTagExamEl) {
          materialTagExamEl.textContent = q.material;
          materialTagExamEl.classList.remove("hidden");
        } else if (materialTagExamEl) {
          // Sembunyikan jika tidak ada materi
          materialTagExamEl.classList.add("hidden");
        }

        // Update progress bar
        const progressPercentage = questions.length > 0 ? ((index + 1) / questions.length) * 100 : 0;
        if (progressBarInner) progressBarInner.style.width = `${progressPercentage}%`;

        // Buat dan tampilkan opsi jawaban
        q.options.forEach((option, i) => {
          const optionId = `q${index}_option${i}`; // ID unik untuk input radio
          const isSelected = userAnswers[index] === i; // Cek apakah opsi ini dipilih sebelumnya

          // Buat div pembungkus (card) untuk setiap opsi
          const card = document.createElement("div");
          card.classList.add(
            "option-card", // Kelas dasar dari CSS
            "border",
            "border-gray-300", // Styling border
            "rounded-lg", // Sudut membulat
            "bg-white" // Background default
          );
          // Tambahkan kelas jika opsi ini terpilih
          if (isSelected) {
            card.classList.add("selected-answer", "bg-blue-100"); // Kelas terpilih dari CSS
            card.classList.remove("bg-white"); // Hapus background default
          }

          // Buat input radio (tersembunyi oleh CSS)
          const input = document.createElement("input");
          input.type = "radio";
          input.id = optionId;
          input.name = `question_${index}`; // Nama grup radio (sama untuk semua opsi di soal ini)
          input.value = i; // Nilai adalah indeks opsi
          input.checked = isSelected; // Set status checked
          // Tambahkan event listener untuk memanggil selectAnswer saat dipilih
          input.onchange = () => selectAnswer(index, i);

          // Buat label untuk input radio (ini yang akan terlihat dan diklik)
          const label = document.createElement("label");
          // Menggabungkan gaya dari CSS dan Tailwind untuk label
          label.className = "block cursor-pointer user-select-none p-3 text-sm md:p-4 md:text-base";
          label.htmlFor = optionId; // Hubungkan label dengan input radio
          const optionLabel = String.fromCharCode(65 + i); // Buat label huruf (A, B, C, ...)
          label.textContent = `${optionLabel}. ${option}`; // Set teks label (misal: "A. Opsi pertama")

          // Masukkan input dan label ke dalam card
          card.appendChild(input);
          card.appendChild(label);

          // Masukkan card ke dalam kontainer opsi
          optionsContainerEl.appendChild(card);
        });

        // Perbarui status tombol navigasi (Sebelumnya, Berikutnya, Submit)
        updateNavigationButtons();
      }

      /**
       * Memperbarui status enabled/disabled dan visibility tombol navigasi ujian
       * (Sebelumnya, Berikutnya, Submit) berdasarkan state saat ini.
       */
      function updateNavigationButtons() {
        // Tombol "Sebelumnya" aktif jika bukan soal pertama
        prevButton.disabled = currentQuestionIndex === 0;

        // Cek apakah soal saat ini sudah dijawab
        const isCurrentAnswered = userAnswers[currentQuestionIndex] !== null;

        // Tombol "Berikutnya" aktif jika soal saat ini sudah dijawab DAN bukan soal terakhir
        nextButton.disabled = !isCurrentAnswered || currentQuestionIndex === questions.length - 1;

        // Tombol "Submit" aktif jika soal saat ini sudah dijawab DAN ini adalah soal terakhir
        submitButton.disabled = !isCurrentAnswered || currentQuestionIndex !== questions.length - 1;

        // Tampilkan/sembunyikan tombol "Berikutnya" dan "Submit"
        if (currentQuestionIndex === questions.length - 1) {
          // Jika di soal terakhir
          nextButton.classList.add("hidden"); // Sembunyikan "Berikutnya"
          submitButton.classList.remove("hidden"); // Tampilkan "Submit"
        } else {
          // Jika bukan di soal terakhir
          nextButton.classList.remove("hidden"); // Tampilkan "Berikutnya"
          submitButton.classList.add("hidden"); // Sembunyikan "Submit"
        }
      }

      /**
       * Menyimpan jawaban pengguna untuk soal tertentu dan memperbarui tampilan visual opsi.
       * @param {number} questionIndex - Indeks soal yang dijawab.
       * @param {number} answerIndex - Indeks opsi yang dipilih pengguna.
       */
      function selectAnswer(questionIndex, answerIndex) {
        // Simpan jawaban pengguna ke array userAnswers
        userAnswers[questionIndex] = answerIndex;

        // Dapatkan semua elemen card opsi untuk soal saat ini
        const currentOptions = optionsContainerEl.querySelectorAll(".option-card");

        // Reset tampilan semua card opsi (hapus highlight biru)
        currentOptions.forEach((card) => {
          card.classList.remove("selected-answer", "bg-blue-100");
          card.classList.add("bg-white"); // Kembalikan background putih jika perlu
        });

        // Temukan card yang sesuai dengan opsi yang baru dipilih
        // Kita cari input radio berdasarkan ID, lalu ambil parent elementnya (card)
        const selectedCard = optionsContainerEl.querySelector(`#q${questionIndex}_option${answerIndex}`)?.parentElement;

        // Jika card ditemukan, tambahkan highlight biru
        if (selectedCard) {
          selectedCard.classList.add("selected-answer", "bg-blue-100");
          selectedCard.classList.remove("bg-white"); // Hapus background putih
        } else {
          console.warn(`Card untuk #q${questionIndex}_option${answerIndex} tidak ditemukan.`);
        }

        // Perbarui status tombol navigasi (misalnya, aktifkan tombol "Berikutnya")
        updateNavigationButtons();
      }

      /** Pindah ke soal berikutnya jika memungkinkan. */
      function nextQuestion() {
        if (currentQuestionIndex < questions.length - 1) {
          currentQuestionIndex++;
          displayQuestion(currentQuestionIndex);
        }
      }

      /** Pindah ke soal sebelumnya jika memungkinkan. */
      function previousQuestion() {
        if (currentQuestionIndex > 0) {
          currentQuestionIndex--;
          displayQuestion(currentQuestionIndex);
        }
      }

      /**
       * Mengirim jawaban ujian, menghitung skor, menghentikan timer,
       * dan menampilkan halaman hasil.
       * @param {boolean} [isTimeUp=false] - Opsional, true jika submit dipicu oleh waktu habis.
       */
      function submitExam(isTimeUp = false) {
        stopTimer(); // Selalu hentikan timer saat submit
        timeIsUp = isTimeUp; // Set flag apakah waktu habis

        // Hitung jumlah soal yang belum dijawab
        const unanswered = userAnswers.filter((ans) => ans === null).length;

        // Tampilkan konfirmasi HANYA jika submit dilakukan manual (bukan karena waktu habis)
        // DAN masih ada soal yang belum dijawab.
        if (!isTimeUp && unanswered > 0) {
          const confirmation = confirm(`Ada ${unanswered} soal yang belum terjawab. Yakin ingin mengirim ujian?`);
          if (!confirmation) {
            // Jika pengguna membatalkan, mulai lagi timer jika masih ada waktu
            if (timerSeconds > 0) {
              startTimer();
            }
            return; // Hentikan proses submit
          }
        }

        // Lanjutkan proses perhitungan skor
        score = 0;
        let correctCount = 0;
        for (let i = 0; i < questions.length; i++) {
          // Pastikan data soal ada sebelum membandingkan
          if (questions[i] && userAnswers[i] !== null && userAnswers[i] === questions[i].correctAnswer) {
            correctCount++;
          }
        }

        // Hitung skor (persentase pembulatan)
        score = questions.length > 0 ? Math.round((correctCount / questions.length) * 100) : 0;

        // Tampilkan hasil
        displayResults();
        showPage("results-page"); // Pindah ke halaman hasil
      }

      /**
       * Menampilkan halaman hasil ujian: skor, ringkasan, rincian jawaban per soal
       * (termasuk indikasi benar/salah, jawaban pengguna, jawaban benar, dan pembahasan),
       * serta memicu animasi confetti.
       */
      function displayResults() {
        // Tampilkan skor akhir dan ringkasan
        finalScoreEl.textContent = `${score} / 100`;
        const correctCount = questions.length > 0 ? Math.round((score / 100) * questions.length) : 0;
        scoreSummaryEl.textContent = `Anda menjawab ${correctCount} dari ${questions.length} soal dengan benar.`;

        // Kosongkan kontainer rincian sebelum menambahkan yang baru
        resultsDetailsContainerEl.innerHTML = "";

        // Tampilkan pesan jika waktu habis
        if (timeIsUp && timeUpInfoEl) {
          timeUpInfoEl.classList.remove("hidden");
        } else if (timeUpInfoEl) {
          timeUpInfoEl.classList.add("hidden");
        }

        // Iterasi melalui setiap soal untuk menampilkan rinciannya
        questions.forEach((q, index) => {
          // Lewati jika data soal tidak valid (seharusnya tidak terjadi jika validasi benar)
          if (!q) return;

          // Buat div utama untuk rincian soal ini
          const resultDiv = document.createElement("div");
          resultDiv.classList.add("p-4", "md:p-5", "bg-white", "rounded-lg", "border", "border-gray-200", "shadow-sm");

          // Tambahkan tag materi jika ada
          if (q.material) {
            const materialTag = document.createElement("span");
            materialTag.className = "material-tag"; // Gunakan kelas CSS yang sudah ada
            materialTag.textContent = q.material;
            resultDiv.appendChild(materialTag);
          }

          // Tampilkan teks pertanyaan (gunakan innerHTML lagi untuk hasil)
          const questionP = document.createElement("div"); // Ubah ke div untuk innerHTML
          // Gunakan kelas CSS yang ditambahkan untuk styling list dan paragraf
          questionP.classList.add("text-base", "md:text-lg", "font-medium", "text-gray-800", "mb-4", "mt-1");
          questionP.innerHTML = `${index + 1}. ${q.question}`; // Gunakan innerHTML
          resultDiv.appendChild(questionP);

          // Buat kontainer untuk opsi jawaban
          const optionsDiv = document.createElement("div");
          optionsDiv.classList.add("space-y-2", "md:space-y-3"); // Beri jarak antar opsi

          // Iterasi melalui setiap opsi jawaban
          q.options.forEach((option, i) => {
            const optionCard = document.createElement("div");
            // Styling dasar card opsi di hasil
            optionCard.className = "p-2 text-sm md:p-3 md:text-base rounded-md border";

            const isCorrectAnswer = i === q.correctAnswer; // Apakah ini jawaban yang benar?
            const isUserChoice = userAnswers[index] === i; // Apakah ini yang dipilih pengguna?
            const optionLabel = String.fromCharCode(65 + i); // Label huruf (A, B, C...)
            const optionTextContent = `${optionLabel}. ${option}`; // Teks opsi dasar

            optionCard.textContent = optionTextContent; // Set teks awal

            let statusText = ""; // Teks status (misal: Jawaban Benar)
            let statusSpanClass = "font-semibold"; // Kelas default untuk span status

            // Tentukan gaya dan teks status berdasarkan kondisi
            if (isCorrectAnswer) {
              optionCard.classList.add("correct-answer-style"); // Gaya jawaban benar
              statusText = "(Jawaban Benar)";
              if (isUserChoice) {
                statusText = "(Jawaban Anda Benar)"; // Jika pengguna memilih yang benar
              }
            } else if (isUserChoice) {
              optionCard.classList.add("incorrect-answer-style"); // Gaya jawaban salah yang dipilih
              statusText = "(Jawaban Anda)";
            } else {
              // Opsi lain yang tidak dipilih dan tidak benar
              optionCard.classList.add("bg-gray-100", "border-gray-200", "text-gray-600");
            }

            // Tambahkan teks status jika ada
            if (statusText) {
              optionCard.textContent = optionTextContent + " "; // Tambah spasi setelah teks opsi
              const span = document.createElement("span");
              span.className = statusSpanClass;
              span.textContent = statusText;
              optionCard.appendChild(span); // Tambahkan span status
            }

            optionsDiv.appendChild(optionCard); // Tambahkan card opsi ke kontainer opsi
          });

          resultDiv.appendChild(optionsDiv); // Tambahkan kontainer opsi ke div hasil

          // Tampilkan pembahasan jika ada dan tidak kosong
          if (q.explanation && q.explanation.trim() !== "") {
            const explanationDiv = document.createElement("div");
            explanationDiv.classList.add("explanation-box"); // Gunakan kelas CSS yang sudah ada

            const explanationTitle = document.createElement("strong");
            explanationTitle.textContent = "Pembahasan: ";
            explanationTitle.classList.add("text-gray-800"); // Sedikit penekanan pada judul

            const explanationText = document.createElement("span");
            explanationText.textContent = q.explanation; // Teks pembahasan

            explanationDiv.appendChild(explanationTitle);
            explanationDiv.appendChild(explanationText);
            resultDiv.appendChild(explanationDiv); // Tambahkan kotak pembahasan
          }

          // Tambahkan div hasil soal ini ke kontainer utama rincian
          resultsDetailsContainerEl.appendChild(resultDiv);
        });

        // Picu animasi confetti setelah semua hasil ditampilkan
        triggerConfetti();
      }

      /** Memulai animasi confetti menggunakan library canvas-confetti. */
      function triggerConfetti() {
        // Pastikan myConfetti sudah diinisialisasi
        if (typeof myConfetti === "function") {
          // Tembakan utama dari tengah atas
          myConfetti({
            particleCount: 150, // Jumlah partikel lebih banyak
            spread: 100, // Sebaran lebih lebar
            origin: { y: 0.6 }, // Mulai sedikit di bawah tengah layar
          });
          // Tembakan dari sisi kiri
          myConfetti({
            particleCount: 50,
            angle: 60, // Arah ke kanan atas
            spread: 55,
            origin: { x: 0 }, // Mulai dari tepi kiri
          });
          // Tembakan dari sisi kanan
          myConfetti({
            particleCount: 50,
            angle: 120, // Arah ke kiri atas
            spread: 55,
            origin: { x: 1 }, // Mulai dari tepi kanan
          });
        } else {
          console.warn("Fungsi confetti tidak ditemukan atau belum siap.");
        }
      }

      /**
       * Mengatur ulang aplikasi ke kondisi awal (halaman landing)
       * untuk memulai ujian baru. Menghentikan timer dan membersihkan state.
       */
      function restartExam() {
        stopTimer(); // Hentikan timer jika sedang berjalan
        questions = []; // Kosongkan array soal
        userAnswers = []; // Kosongkan jawaban pengguna
        currentQuestionIndex = 0; // Reset indeks soal
        score = 0; // Reset skor
        totalExamTimeSeconds = 0; // Reset total waktu
        timeIsUp = false; // Reset flag waktu habis

        resetUploadState(); // Reset input file dan status di landing page

        // Reset UI elemen di halaman ujian dan hasil jika perlu
        if (progressBarInner) progressBarInner.style.width = "0%";
        if (materialTagExamEl) materialTagExamEl.classList.add("hidden");
        if (timerDisplayEl) timerDisplayEl.classList.add("hidden");
        if (timeLeftEl) timeLeftEl.textContent = "--:--";
        if (timeUpInfoEl) timeUpInfoEl.classList.add("hidden");
        if (resultsDetailsContainerEl) resultsDetailsContainerEl.innerHTML = ""; // Kosongkan rincian hasil

        showPage("landing-page"); // Kembali ke halaman landing
      }

      // --- Fungsi Timer ---

      /** Memulai timer ujian berdasarkan `totalExamTimeSeconds`. */
      function startTimer() {
        stopTimer(); // Hentikan timer sebelumnya jika ada untuk mencegah duplikasi
        timerSeconds = totalExamTimeSeconds; // Set waktu awal dari total yang dihitung

        // Jangan mulai timer jika waktu tidak valid (0 atau negatif)
        if (timerSeconds <= 0) {
          console.warn("Total waktu ujian 0 atau negatif, timer tidak dimulai.");
          if (timerDisplayEl) timerDisplayEl.classList.add("hidden"); // Pastikan display timer tersembunyi
          return;
        }

        // Tampilkan elemen timer jika waktu valid
        if (timerDisplayEl) timerDisplayEl.classList.remove("hidden");
        updateTimerDisplay(); // Tampilkan waktu awal (MM:SS)

        // Mulai interval yang berjalan setiap 1 detik (1000 ms)
        timerInterval = setInterval(() => {
          timerSeconds--; // Kurangi sisa waktu
          updateTimerDisplay(); // Perbarui tampilan timer

          // Cek jika waktu habis
          if (timerSeconds <= 0) {
            console.log("Waktu habis!");
            stopTimer(); // Hentikan interval
            // Beri notifikasi kepada pengguna (alert sederhana, bisa diganti modal)
            alert("Waktu pengerjaan telah habis! Ujian akan otomatis dikirim.");
            submitExam(true); // Submit otomatis, tandai bahwa waktu habis
          }
        }, 1000);
      }

      /** Menghentikan interval timer ujian. */
      function stopTimer() {
        clearInterval(timerInterval); // Hapus interval yang tersimpan
        timerInterval = null; // Reset variabel ID interval
      }

      /** Memperbarui tampilan sisa waktu pada elemen #time-left dalam format MM:SS. */
      function updateTimerDisplay() {
        // Pastikan elemen display ada
        if (!timeLeftEl || !timerDisplayEl) return;

        // Hitung menit dan detik dari total detik tersisa
        const minutes = Math.floor(timerSeconds / 60);
        const seconds = timerSeconds % 60;

        // Format waktu menjadi MM:SS (misal: 05:30)
        timeLeftEl.textContent = `${String(minutes).padStart(2, "0")}:${String(seconds).padStart(2, "0")}`;

        // Tambahkan/hapus kelas CSS jika waktu hampir habis (misal, kurang dari 1 menit)
        if (timerSeconds < 60 && timerSeconds > 0) {
          // Beri warna merah jika < 60 detik
          timerDisplayEl.classList.add("time-low");
        } else {
          timerDisplayEl.classList.remove("time-low"); // Hapus warna merah jika >= 60 detik
        }
        // Jika waktu 0, pastikan tidak ada kelas 'time-low' lagi
        if (timerSeconds <= 0) {
          timerDisplayEl.classList.remove("time-low");
          timeLeftEl.textContent = "00:00"; // Pastikan tampil 00:00 saat habis
        }
      }

      // --- Event Listeners ---
      // Listener untuk tombol di dialog error PDF
      useDummyDataButton.addEventListener("click", () => {
        console.log("Menggunakan data contoh...");
        // Gunakan data mock sebagai fallback, panggil flattenJsonData untuk format
        questions = flattenJsonData(mockQuestions);
        calculateAndShowTotalTime(); // Hitung waktu untuk data contoh
        hideErrorDialog(); // Sembunyikan dialog error
        proceedToOnboarding(); // Lanjutkan ke halaman onboarding
      });
      tryAnotherFileButton.addEventListener("click", () => {
        console.log("Memilih file lain...");
        hideErrorDialog(); // Sembunyikan dialog, pengguna akan memilih file lagi
      });

      // Listener untuk tombol di dalam Modal JSON
      // Memicu klik pada input file JSON yang tersembunyi
      triggerJsonUploadButton.addEventListener("click", () => jsonUploadInput.click());
      // Menampilkan daftar file JSON yang tersedia (simulasi)
      showAvailableJsonButton.addEventListener("click", showAvailableJsonList);

      // --- Inisialisasi Aplikasi ---
      // Tampilkan halaman landing saat pertama kali dimuat
      showPage("landing-page"); // Dikembalikan ke pemanggilan langsung
    </script>
  </body>
</html>
